name: UI tests + Allure

on:
  permissions:
    contents: read
    pages: write
    id-token: write

  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          # твой requirements.txt содержит "-e ." — это ок, если packaging уже починен (у тебя есть pyproject.toml + setup.cfg)
          pip install -r requirements.txt

      - name: Install Playwright Chromium
        run: |
          python -m playwright install --with-deps chromium

      - name: Run pytest (collect Allure results)
        env:
          HEADLESS: "true"
          # если у тебя BASE_URL берётся из env — оставь так
          BASE_URL: "https://www.sport-express.ru"
          SLOWMO: "0"
        run: |
          python -m pytest --alluredir=allure-results

      - name: Install Allure CLI
        if: always()
        run: |
          sudo apt-get update
          sudo apt-get install -y default-jre
          curl -Ls -o allure.tgz https://github.com/allure-framework/allure2/releases/latest/download/allure-2.29.0.tgz
          tar -xzf allure.tgz
          sudo mv allure-2.29.0 /opt/allure
          sudo ln -sf /opt/allure/bin/allure /usr/local/bin/allure
          allure --version

      - name: Generate Allure report
        if: always()
        run: |
          allure generate allure-results -o allure-report --clean || true

      - name: Upload Allure results (raw)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: allure-results
          if-no-files-found: warn
          retention-days: 14

      - name: Upload Allure report (HTML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report
          if-no-files-found: warn
          retention-days: 14
  deploy-pages:
    name: Publish Allure to GitHub Pages
    needs: tests
    if: always() && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact (Allure report)
        uses: actions/upload-pages-artifact@v3
        with:
          path: allure-report

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
